_schema-version: 3.3.0
ID: cnma_react_app
version: 1.0.0
description: "A simple CAP project."

parameters:
  enable-parallel-deployments: true
  deploy_mode: html5-repo

build-parameters:
  before-all:
    - builder: custom
      commands:
        - npm install --production
        - npx -p @sap/cds-dk cds build --production
        - npm --prefix ./app install ./app
        - npm run build --prefix ./app

modules:
  - name: cnma_react_app_srv
    type: nodejs
    path: gen/srv
    parameters:
      instances: 1
      buildpack: nodejs_buildpack
    build-parameters:
      builder: npm-ci
    provides:
      - name: srv-api # required by consumers of CAP services (e.g. approuter)
        properties:
          srv-url: ${default-url}
    requires:
      []

 # --------------------- APPROUTER MODULE ---------------------
  - name: cnma_react_approuter
 # ------------------------------------------------------------
    type: approuter.nodejs
    path: approuter
    requires:
      - name: cnma_react_html5_runtime
      - name: cnma_react_destination

  # --------------------- HTML5DEPLOYER MODULE -----------------
  - name: cnma_react_hmtl5_deployer
 # ------------------------------------------------------------
    type: com.sap.application.content
    path: .
    parameters:
      memory: 2048M
      disk-quota: 2048M
      public: true
    requires:
      - name: cnma_react_html5_host
        parameters:
          content-target: true
    build-parameters:
      build-result: ui_resources        # This is the folder containing the build files
      ignore:
        - node_modules/.cache/
        - .git/
        - "*.md"
      requires:
        - name: cnma_react_html5_ui
          artifacts:
            - './*'
          target-path: ui_resources/

 # --------------------- REACT APP MODULE ---------------------
  - name: cnma_react_html5_ui
    type: html5
    path: app
    build-parameters:
      build-result: dist
      builder: custom
      commands:
        - npm ci
        - npm run build:zip
      ignore:
        - node_modules/
        - src/
        - public/
        - .git/
        - .gitignore
        - .env*
        - "*.md"
        - tests/
        - coverage/
        - package-lock.json
        - yarn.lock
      supported-platforms: []

  # ------------------------------------------------------------
  # (5) UI REPO REGISTRY MODULE
  # ------------------------------------------------------------
  - name: cnma_react_destination_content
    type: com.sap.application.content    

    requires:
    - name: cnma_react_html5_host
      parameters:
        service-key:
          name: cnma_react_html5_host_key

    - name: cnma_react_destination
      parameters:
        content-target: true   

    build-parameters:
      no-source: true
    parameters:      
      content:
        instance:
          existing_destinations_policy: update                     
          destinations:
          - Name: cnma_react_html5_dest
            ServiceInstanceName: cnma_react_html5_host
            ServiceKeyName: cnma_react_html5_host_key
            sap.cloud.service: cnma.reactapp   

resources:
   # --------------------- HTML5 Runtime ----------------------
 - name: cnma_react_html5_runtime
 # ------------------------------------------------------------
   parameters:
     service-name: cnma_react_html5_runtime
     service-plan: app-runtime
     service: html5-apps-repo
   type: org.cloudfoundry.managed-service

# --------------------- HTML5 Host -------------------------
 - name: cnma_react_html5_host
# ------------------------------------------------------------
   parameters:
     service-name: cnma_react_html5_host
     service-plan: app-host
     service: html5-apps-repo
   type: org.cloudfoundry.managed-service

  # ------------------------------------------------------------
  # (4) DESTINATION SERVICE INSTANCE
  # ------------------------------------------------------------
 - name: cnma_react_destination
   type: org.cloudfoundry.managed-service
   requires:
    - name: srv-api
   parameters:
     service: destination
     service-plan: lite
     forwardAuthToken: true
     config:
       HTML5Runtime_enabled: true
       init_data:
         instance:
           existing_destinations_policy: ignore
           destinations:
             - Name: cnma_react_srv_destination
               Description: Supplier Inquiry destination
               Authentication: NoAuthentication
               ProxyType: Internet
               Type: HTTP
               URL: ~{srv-api/srv-url}
               HTML5.DynamicDestination: true
               HTML5.ForwardAuthToken: true
               HTML5.Timeout: 600000